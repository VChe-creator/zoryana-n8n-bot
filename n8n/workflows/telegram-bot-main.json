{
  "nodes": [
    {
      "parameters": {
        "authentication": "webhookBasic",
        "path": "telegram-webhook"
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        250,
        300
      ]
    },
    {
      "parameters": {
        "botToken": "={{ $env.TELEGRAM_BOT_TOKEN }}",
        "updates": [
          "message",
          "callback_query"
        ]
      },
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [
        450,
        300
      ]
    },
    {
      "parameters": {
        "functionCode": "try {\n  const message = items[0].json;\n  const userId = message.message?.from?.id || message.callback_query?.from?.id;\n  const text = message.message?.text || message.callback_query?.data;\n\n  return {\n    json: {\n      userId,\n      text,\n      rawData: message\n    }\n  };\n} catch (error) {\n  return {\n    json: {\n      error: true,\n      message: '–í–∏–±–∞—á—Ç–µ, —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.'\n    }\n  }\n}"
      },
      "name": "Parse Update",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        650,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.text }}",
              "value2": "/start"
            }
          ]
        }
      },
      "name": "Is Start Command?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        850,
        300
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.userId }}",
        "text": "–í—ñ—Ç–∞—é! –Ø –≤–∞—à –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–∏–π –ø–æ–º—ñ—á–Ω–∏–∫. –û–±–µ—Ä—ñ—Ç—å, –±—É–¥—å –ª–∞—Å–∫–∞, —Ä–æ–∑–¥—ñ–ª:\n\nüîÆ –ê—Å—Ç—Ä–æ–ª–æ–≥—ñ—è\nüî¢ –ù—É–º–µ—Ä–æ–ª–æ–≥—ñ—è\n‚≠ê –¢–∞—Ä–æ",
        "additionalFields": {
          "reply_markup": {
            "inline_keyboard": [
              [
                {
                  "text": "üîÆ –ê—Å—Ç—Ä–æ–ª–æ–≥—ñ—è",
                  "callback_data": "astrology"
                }
              ],
              [
                {
                  "text": "üî¢ –ù—É–º–µ—Ä–æ–ª–æ–≥—ñ—è",
                  "callback_data": "numerology"
                }
              ],
              [
                {
                  "text": "‚≠ê –¢–∞—Ä–æ",
                  "callback_data": "tarot"
                }
              ]
            ]
          }
        }
      },
      "name": "Send Main Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1050,
        200
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.text }}",
              "value2": "astrology"
            }
          ]
        }
      },
      "name": "Is Astrology?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        850,
        400
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.userId }}",
        "text": "–û–±–µ—Ä—ñ—Ç—å –≤–∞—à –∑–Ω–∞–∫ –∑–æ–¥—ñ–∞–∫—É:",
        "additionalFields": {
          "reply_markup": {
            "inline_keyboard": [
              [
                {"text": "‚ôà –û–≤–µ–Ω", "callback_data": "zodiac_aries"},
                {"text": "‚ôâ –¢–µ–ª–µ—Ü—å", "callback_data": "zodiac_taurus"},
                {"text": "‚ôä –ë–ª–∏–∑–Ω—é–∫–∏", "callback_data": "zodiac_gemini"}
              ],
              [
                {"text": "‚ôã –†–∞–∫", "callback_data": "zodiac_cancer"},
                {"text": "‚ôå –õ–µ–≤", "callback_data": "zodiac_leo"},
                {"text": "‚ôç –î—ñ–≤–∞", "callback_data": "zodiac_virgo"}
              ],
              [
                {"text": "‚ôé –¢–µ—Ä–µ–∑–∏", "callback_data": "zodiac_libra"},
                {"text": "‚ôè –°–∫–æ—Ä–ø—ñ–æ–Ω", "callback_data": "zodiac_scorpio"},
                {"text": "‚ôê –°—Ç—Ä—ñ–ª–µ—Ü—å", "callback_data": "zodiac_sagittarius"}
              ],
              [
                {"text": "‚ôë –ö–æ–∑–µ—Ä—ñ–≥", "callback_data": "zodiac_capricorn"},
                {"text": "‚ôí –í–æ–¥–æ–ª—ñ–π", "callback_data": "zodiac_aquarius"},
                {"text": "‚ôì –†–∏–±–∏", "callback_data": "zodiac_pisces"}
              ],
              [{"text": "üîô –ù–∞–∑–∞–¥", "callback_data": "/start"}]
            ]
          }
        }
      },
      "name": "Send Zodiac Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1050,
        400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.text }}",
              "value2": "numerology"
            }
          ]
        }
      },
      "name": "Is Numerology?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        850,
        500
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.userId }}",
        "text": "–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –Ω—É–º–µ—Ä–æ–ª–æ–≥—ñ—á–Ω–æ–≥–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É:",
        "additionalFields": {
          "reply_markup": {
            "inline_keyboard": [
              [{"text": "1Ô∏è‚É£ –ß–∏—Å–ª–æ –∂–∏—Ç—Ç—î–≤–æ–≥–æ —à–ª—è—Ö—É", "callback_data": "num_life_path"}],
              [{"text": "2Ô∏è‚É£ –ß–∏—Å–ª–æ –æ—Å–æ–±–∏—Å—Ç–æ–≥–æ —Ä–æ–∫—É", "callback_data": "num_personal_year"}],
              [{"text": "‚ù§Ô∏è –ù—É–º–µ—Ä–æ–ª–æ–≥—ñ—á–Ω–∞ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å", "callback_data": "num_compatibility"}],
              [{"text": "üë§ –ß–∏—Å–ª–æ —ñ–º–µ–Ω—ñ", "callback_data": "num_name"}],
              [{"text": "üîô –ù–∞–∑–∞–¥", "callback_data": "/start"}]
            ]
          }
        }
      },
      "name": "Send Numerology Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1050,
        500
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.text }}",
              "value2": "tarot"
            }
          ]
        }
      },
      "name": "Is Tarot?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        850,
        600
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.userId }}",
        "text": "üîÆ –†–æ–∑–¥—ñ–ª –¢–∞—Ä–æ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ. –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —ñ–Ω—à–∏–π —Ä–æ–∑–¥—ñ–ª.",
        "additionalFields": {
          "reply_markup": {
            "inline_keyboard": [
              [{"text": "üîô –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é", "callback_data": "/start"}]
            ]
          }
        }
      },
      "name": "Send Tarot Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1050,
        600
      ]
    },
    {
      "parameters": {
        "functionCode": "try {\n  const redis = $node['Redis'];\n  if (!redis) {\n    throw new Error('Redis –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∏–π');\n  }\n\n  // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞\n  await redis.set(`user:${$json.userId}:state`, $json.text);\n  \n  return $json;\n} catch (error) {\n  console.error('Redis error:', error);\n  return $json; // –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –±–µ–∑ Redis\n}",
        "name": "Handle Redis State"
      },
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1050,
        700
      ]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Telegram Trigger",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Parse Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Update": {
      "main": [
        [
          {
            "node": "Error Handler",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Handler": {
      "main": [
        [
          {
            "node": "Send Main Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Start Command?": {
      "main": [
        [
          {
            "node": "Send Main Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Is Astrology?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Astrology?": {
      "main": [
        [
          {
            "node": "Send Zodiac Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Is Numerology?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Numerology?": {
      "main": [
        [
          {
            "node": "Send Numerology Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Is Tarot?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Tarot?": {
      "main": [
        [
          {
            "node": "Send Tarot Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
} 